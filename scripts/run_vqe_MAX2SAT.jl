using HDF5 
using Printf
using LinearAlgebra
using DataFrames
import Random, Distributions

using VQE
using Zygote
using PyPlot
using Parameters
using NLopt
using DocStringExtensions
using OrdinaryDiffEq
#using Yao
using YaoBlocks, ChainRulesCore



function expand_blocks(arr::Vector{T}, n::Int) where T
    """
    Given `arr` of length p*(2n+1), split into p blocks each of length (2n+1).
    For each block:
      - After the n-th element, insert two copies of that element.
      - After the (2n)-th element, insert two copies of that element.
    The resulting block has length (2n+5). Concatenate all p expanded blocks
    and return the final expanded array of length p*(2n+5).
    """
    
    # Number of blocks
    block_len = 2n + 1
    p = length(arr) รท block_len
    
    # Prepare the result container (length p*(2n + 5))
    new_len = p * (2n + 5)
    new_arr = Vector{T}(undef, new_len)
    
    # We'll track position in new_arr as we go
    idx_new = 1
    
    for block_idx in 0:(p-1)
        # Identify the sub-block in arr
        start_idx = block_idx * block_len + 1
        stop_idx  = start_idx + block_len - 1
        block = arr[start_idx : stop_idx]  # length (2n+1)
        
        # 1) Copy elements 1..n
        for i in 1:n
            new_arr[idx_new] = block[i]
            idx_new += 1
        end
        
        # 2) Insert two copies of the n-th element
        new_arr[idx_new]   = block[n]
        new_arr[idx_new+1] = block[n]
        idx_new += 2
        
        # 3) Copy elements (n+1)..(2n)
        for i in (n+1):(2n)
            new_arr[idx_new] = block[i]
            idx_new += 1
        end
        
        # 4) Insert two copies of the (2n)-th element
        new_arr[idx_new]   = block[2n]
        new_arr[idx_new+1] = block[2n]
        idx_new += 2
        
        # 5) Finally, copy the last element (index 2n+1)
        new_arr[idx_new] = block[2n+1]
        idx_new += 1
    end
    
    return new_arr
end


# load the MAX2SAT instance data

N = 12
#N = parse(Int, ARGS[1])
num_clauses = 60 #3N

p = 15

PATH = raw"/home/ubuntu/MAX2SAT/"


# permutation data
#folder_name = PATH * @sprintf("//MAX2SAT_transformation_instances//N_%i//", N);
#folder_name = PATH * @sprintf("//MAX2SAT_transformation_instances//N_%i//cl_60//", N);

# transformation data
folder_name = PATH * @sprintf("//MAX2SAT_transformation_instances//trans_test//N_%i//cl_60//", N);


### change N in the pattern individually 
pattern = r"transformed_MAX2SAT_instance_N_12_idx_(\d{4})\.h5"

###

instance_names = readdir(folder_name)
loop_var = 1
#loop_var = parse(Int, ARGS[2])
total_num_inst = 0


for (k, instance_name) in enumerate(instance_names[loop_var+0:loop_var+199])

    global total_num_inst = k
    println("current instance count: ", k)

    idx = match(pattern, instance_name)[1]
    idx = parse(Int64, idx)
    println("idx: ", idx)

    file_name = folder_name * @sprintf("transformed_MAX2SAT_instance_N_%i_idx_%04i.h5", N , idx)

    gs_energy = h5read(file_name, "ground_state_energy") 
    J_mat = h5read(file_name, "couplings"); 
    local_fields = h5read(file_name, "local_fields")
    mf_problem = Problem(0, - local_fields, J_mat);
    println(gs_energy)


    MAX_problem = Problem(p, - local_fields, J_mat) # minus sign added to local fields for MAX2SAT

    #circ = VQE.circuit(SK_problem)
    #num_params = VQE.nparameters(circ)
    num_params = (2*N+1)*p


    global learning_rate =  0.005 
    niter = 100

    global best_cost = 0
    global best_params = zeros(num_params)
    global best_initial_params = zeros(num_params)
    global best_lr = learning_rate
    global best_probs = zeros(Float64, 2^N)

    """
    min_params = 0.001 # starting initial parameter
    #max_params = 0.8
    n_params_step = 10
    
    for j in 1:1
        
        for i in 1:n_params_step
             
            initial_params = vcat([min_params for _ in 1:num_params])
            cost, params, probs, params_hist = optimize_parameters_mix(MAX_problem, initial_params, niter=niter, learning_rate=learning_rate)
            #println(initial_params[1])
            #println(cost)
            #println(params)
            
            if abs(cost) > abs(best_cost)
                global best_cost = cost
                global best_params = params
                global best_initial_params = initial_params
                global best_probs = probs
                global best_lr = learning_rate
            end
        
            min_params += 0.1
        end    

        #min_params = 0.0001
        #global learning_rate += 0.01

    end
    """


     # average
    # p2 best parameter
    #global best_initial_params = [0.861682332749368, 0.7978957343981465, 0.8585429724053355, 0.8645132402377183, 0.8985473027752626, 0.9598082996742322, 1.0140306412759141, 1.0934773740165622, 1.1655539646175677, 1.2719077188844004, 1.2739428264599657, 1.3328285023535495, 0.41217562355404774, 0.5280249191934951, 0.5709457096484611, 0.46078044083558156, 0.5118519200942954, 0.6242627403349719, 0.6296160587700153, 0.5992178791834399, 0.5265007544602947, 0.5741810035478514, 0.4630577917126587, 0.4211887977504076, 0.06256439610447054, 0.6867388620701902, 0.7278273291126394, 0.7127873276573049, 0.7513203832554526, 0.7208387924481754, 0.6454925022535247, 0.6593174458238982, 0.572310521094997, 0.4637206232257909, 0.3691320356251605, 0.29377537054000963, 0.29971992265969444, 0.4747302299473219, 0.5735272906145514, 0.5801975422974697, 0.5383932184578288, 0.5476204472002502, 0.5966331045065916, 0.568081342431278, 0.5111400941664644, 0.4793682736296545, 0.5167429566745441, 0.5643381435802779, 0.621153580405291, 0.4620754475184087]
    #global best_initial_params = [0.9427448890702492, 0.8787734611299426, 0.97643828501679, 1.0197810120854656, 1.0785005156868646, 1.1688046557291685, 1.2385049193998028, 1.354296330951162, 1.4239239684762266, 1.5116981230163657, 1.5583672470723007, 1.5929367482174004, -0.09273386389838492, 0.2359862533755241, 0.5610785018186264, 0.43318307916107707, 0.4440521095435599, 0.5289627207266137, 0.5310294718000307, 0.6484745985991984, 0.6442004726882351, 0.6185652313404172, 0.5522643232798721, 0.4891751293476708, 0.04348942578262899, 0.7844471713616299, 0.8625067253853215, 0.8406606891584697, 0.8078648215510934, 0.7594608424861586, 0.719190984816867, 0.6893315825598277, 0.5160799593816765, 0.4320113921485286, 0.27851696303840556, 0.2096716949553576, 0.1471172710958438, 0.2718625932107602, 0.4089263263942742, 0.5215423228752774, 0.4954035899641343, 0.4841504735538885, 0.5049033446086304, 0.45656124900127354, 0.4190234734120935, 0.4122325166432287, 0.45490002942356755, 0.47215522338809907, 0.4959666149289643, 0.41111625286282094]

    #global best_initial_params = [0.749235095899941, 0.6929826628686786, 0.7257645951073657, 0.7746972084380715, 0.7971054685183284, 0.8488665647433387, 0.8860964627052986, 0.9454134311994556, 1.02362797109541, 1.0867719521322485, 1.1689349723108562, 1.2884235669120248, -0.11660904765911, 0.12972833081893573, 0.36470944654499876, 0.3410139746823175, 0.30828627438454137, 0.3645516119396421, 0.38856681062670184, 0.4880943075784128, 0.4873829354426269, 0.46550920684737285, 0.40353399388668676, 0.3580958454405851, 0.03821671893881761, 0.700025393798379, 0.7066743459723019, 0.7325037080009649, 0.7291882027442753, 0.7981143255776931, 0.8019143678089381, 0.8506754812222791, 0.8357545429799714, 0.7987945000936744, 0.7480378777661845, 0.7016312478329578, 0.6240641311860199, -0.035176399078067334, 0.11719455950197231, 0.2849760543050712, 0.2681893979978904, 0.22190761027215014, 0.25165123595287897, 0.23426266984299868, 0.2297649093074907, 0.1921092145996646, 0.16388609889487118, 0.16814324505202718, 0.17223137514002193, 0.12082116204489117, 0.6209939955511432, 0.6273285085056677, 0.6259299534926012, 0.616294924394396, 0.6492167144790149, 0.6601989777118834, 0.6397038773116956, 0.5643207361236967, 0.5424091017591641, 0.47696874863296784, 0.4654335426392599, 0.4273922785939813, 0.19254102492648145, 0.302688281361965, 0.42316618244224485, 0.4243037497976872, 0.41995946793202166, 0.4373581898045212, 0.44212277413035345, 0.42800984521979824, 0.4649959672341149, 0.4839708230934455, 0.46262886410439946, 0.4821017080967361, 0.29756659122998563, 0.5910577810060409, 0.6580798114668933, 0.5674000278205191, 0.48949790765719386, 0.43598974677863395, 0.40205881904395396, 0.34559716787386824, 0.2876601368442322, 0.24960762502180522, 0.20713038246324314, 0.17348781198177257, 0.16815228354878553, 0.37858664063501996, 0.47540312045780664, 0.545169367187483, 0.570082290300412, 0.5704496733152261, 0.5836353867532336, 0.5751084609657172, 0.5805697437170992, 0.6029183464374325, 0.5763934208855571, 0.5271164808317974, 0.4524363128672329, 0.5137390762866034]
    
     # p4 best parameter
    #global best_initial_params = [0.6957952300800329, 0.6364609693230894, 0.6615257720687825, 0.6870737025302123, 0.7106951647128325, 0.7335729852442164, 0.7550671566505117, 0.8102424568890422, 0.8921733202013368, 0.941820257503849, 0.973780552552174, 1.058428909157423, 0.16344650437081992, 0.32451822901376515, 0.43279909100316755, 0.3719311690650863, 0.3935148506113154, 0.4585550178406999, 0.4867637308409325, 0.4825682591822963, 0.4733497241432981, 0.47143933838975915, 0.3994229480086211, 0.36025831955037285, 0.05215501370973241, 0.5881790184570097, 0.6005014638472865, 0.6320999922347517, 0.6127835399715148, 0.6669810064045426, 0.6527146633864456, 0.7024902691177856, 0.7330411751274248, 0.7080805314658513, 0.7077474091752737, 0.6359642323818753, 0.5987543688109874, 0.1716028884933512, 0.3045307698647734, 0.3772218666645525, 0.34479079449174815, 0.3412128031407019, 0.38319683802659676, 0.38592659140262164, 0.3162876124224209, 0.26382816146495613, 0.2351406370465344, 0.3046841771420242, 0.3550333704829184, 0.11082081456202215, 0.5713353324050935, 0.5474078711639738, 0.5515667362289788, 0.5816880200178293, 0.5945725325313986, 0.5817264716096635, 0.5603667315733075, 0.5422342897044949, 0.4817852695618782, 0.44603894803466104, 0.46920220880571745, 0.4893106205372888, 0.34405345574652185, 0.40582505082835835, 0.4563627627453461, 0.45942653739977707, 0.4497888065232636, 0.4399538326255529, 0.46308979062511807, 0.4157532738172843, 0.450101912208538, 0.4599396525477183, 0.4541071495725916, 0.4916997770832097, 0.3263405421581599, 0.5647240031214084, 0.5745580747677497, 0.47183803338258834, 0.5168224453519958, 0.45229563482552804, 0.4342094058954647, 0.388120139056465, 0.3431667736805881, 0.3136829743898822, 0.27805561225953757, 0.2736542752276506, 0.28453474175909804, 0.47681614745738105, 0.49971323624585595, 0.5228514125852659, 0.5432510201867615, 0.5307560308069407, 0.5173924433719834, 0.5146652999550323, 0.5283539218480915, 0.5842409646841762, 0.5809523199963493, 0.5257180224711296, 0.4701255247631659, 0.4409432919119247]
    #global best_initial_params = [0.749235095899941, 0.6929826628686786, 0.7257645951073657, 0.7746972084380715, 0.7971054685183284, 0.8488665647433387, 0.8860964627052986, 0.9454134311994556, 1.02362797109541, 1.0867719521322485, 1.1689349723108562, 1.2884235669120248, -0.11660904765911, 0.12972833081893573, 0.36470944654499876, 0.3410139746823175, 0.30828627438454137, 0.3645516119396421, 0.38856681062670184, 0.4880943075784128, 0.4873829354426269, 0.46550920684737285, 0.40353399388668676, 0.3580958454405851, 0.03821671893881761, 0.700025393798379, 0.7066743459723019, 0.7325037080009649, 0.7291882027442753, 0.7981143255776931, 0.8019143678089381, 0.8506754812222791, 0.8357545429799714, 0.7987945000936744, 0.7480378777661845, 0.7016312478329578, 0.6240641311860199, -0.035176399078067334, 0.11719455950197231, 0.2849760543050712, 0.2681893979978904, 0.22190761027215014, 0.25165123595287897, 0.23426266984299868, 0.2297649093074907, 0.1921092145996646, 0.16388609889487118, 0.16814324505202718, 0.17223137514002193, 0.12082116204489117, 0.6209939955511432, 0.6273285085056677, 0.6259299534926012, 0.616294924394396, 0.6492167144790149, 0.6601989777118834, 0.6397038773116956, 0.5643207361236967, 0.5424091017591641, 0.47696874863296784, 0.4654335426392599, 0.4273922785939813, 0.19254102492648145, 0.302688281361965, 0.42316618244224485, 0.4243037497976872, 0.41995946793202166, 0.4373581898045212, 0.44212277413035345, 0.42800984521979824, 0.4649959672341149, 0.4839708230934455, 0.46262886410439946, 0.4821017080967361, 0.29756659122998563, 0.5910577810060409, 0.6580798114668933, 0.5674000278205191, 0.48949790765719386, 0.43598974677863395, 0.40205881904395396, 0.34559716787386824, 0.2876601368442322, 0.24960762502180522, 0.20713038246324314, 0.17348781198177257, 0.16815228354878553, 0.37858664063501996, 0.47540312045780664, 0.545169367187483, 0.570082290300412, 0.5704496733152261, 0.5836353867532336, 0.5751084609657172, 0.5805697437170992, 0.6029183464374325, 0.5763934208855571, 0.5271164808317974, 0.4524363128672329, 0.5137390762866034]

    # p6 best parameter
    #global best_initial_params = [0.49625906722091173, 0.5058299363486715, 0.508254027305807, 0.4489171883007216, 0.4484736779627681, 0.4989053593809504, 0.5721099650877357, 0.7241553752060378, 0.6887372123569814, 0.751684923884647, 0.867048985512176, 0.8026432873911951, -0.08270931149298928, 0.036431348841327184, 0.1138071207857784, 0.01655707050893648, 0.060963221407412574, 0.1638091935433288, 0.15750901633940592, 0.30160097496328625, 0.3178939963810278, 0.36848121309159054, 0.2561768462225273, 0.31990376308710883, 0.02575803448393394, 0.5441396238403812, 0.5326672027732607, 0.5359326342270757, 0.43140338491996955, 0.474719714454466, 0.5455604919395675, 0.6794170003951705, 0.7128208411615481, 0.7310333916649537, 0.7599650091858628, 0.7335075543327534, 0.7147827373969252, -0.04990618189329703, -0.02845693247349063, 0.06387716489021793, 0.04910289479806139, 0.12147705486292189, 0.08766968623851691, 0.043705601040415806, 0.11869187404825199, 0.09880580199095497, 0.13093678620702875, 0.011151534931136159, -0.002987023667621615, 0.12327203416763682, 0.49265808153027235, 0.5762611493520304, 0.7991788201970595, 0.6586549909273723, 0.7618767916142913, 0.7591918239007159, 0.8045266188684295, 0.4877125177098302, 0.39576576991250123, 0.30480901161773094, 0.2867266828806294, 0.28612482583798154, 0.08075417301484701, 0.06055846742300075, 0.06423365458707057, 0.11408954949049267, 0.20431666913962832, 0.08267433385382054, 0.12425761229472405, 0.19365330743215933, 0.13557140087888112, 0.23845688889755184, 0.2129582174991271, 0.1814234285166869, 0.18318817811272786, 0.35358847084428174, 0.47405021405072073, 0.6689681186905249, 0.5991618759771479, 0.8277984566640101, 0.6235142657186469, 0.6763023712973636, 0.3288572052122636, 0.17364106936842758, 0.2549468172324143, 0.26354633405305056, 0.28111138644847466, 0.24148135902883677, 0.21043204740066893, 0.18263336758163776, 0.2962948845686856, 0.30767782602697874, 0.2735270702685563, 0.29396479345678117, 0.3936642860656289, 0.34552154468077373, 0.39668232651043495, 0.3768431053342729, 0.3517292062468441, 0.31916060465003687, 0.39221551839624363, 0.478992670815958, 0.607261630652382, 0.4479464897266613, 0.44118565680211563, 0.42509053405973657, 0.39338660397637965, 0.3581000658918781, 0.19222447988674102, 0.20363609223051038, 0.08785008753285917, 0.10598407287679806, 0.36179896741829204, 0.35254104028268574, 0.37492412629109734, 0.39987727780430204, 0.3544122841222347, 0.37352587546431903, 0.3406571839985235, 0.4234390862372306, 0.409710453759741, 0.37268934919637015, 0.3914954941795646, 0.2930614580930485, 0.48231385442648667, 0.17227144475626846, 0.26052597645009457, 0.20533761276160623, 0.17185296140562603, 0.16841925866870538, 0.22619006234151579, 0.07384551255725935, 0.11590623987003124, 0.03217056100049976, 0.0575366967884504, 0.035532831751627324, 0.04592678414689335, 0.35989641006374995, 0.3942516472107045, 0.34754055992626093, 0.34364440755850134, 0.33677329911936527, 0.2606076701094473, 0.3180330999199353, 0.3771490321499643, 0.30474936102796374, 0.27581586619847154, 0.29712196696707455, 0.20881872146185138, 0.6569273191056468]
    #global best_initial_params = [0.6461904384811658, 0.5988686565969672, 0.653148998775513, 0.670078799374985, 0.6838387561953219, 0.7170277276622038, 0.7701925045415255, 0.8168673797550758, 0.8686434332704693, 0.9349480978092545, 0.9998112043799807, 1.089687173314415, 0.008527260592808332, 0.15551693216475754, 0.3416240800661143, 0.34043084980861726, 0.2937649547771549, 0.3619766522832707, 0.35163975943408915, 0.43750519318709363, 0.44561962237018327, 0.40898255801951744, 0.3788515095438516, 0.3449904201614035, 0.041942428772012624, 0.6030515323299563, 0.6066830099720198, 0.6452651799058187, 0.6364136762675601, 0.6635149381101272, 0.7266766363681236, 0.7301573651195936, 0.7544227517343992, 0.7597104169760145, 0.7618694198108191, 0.7228128683393668, 0.6795424112488552, -0.016001586680914066, 0.09519303053666955, 0.22331540344352438, 0.2381945097940332, 0.16575434686416712, 0.21197676787872421, 0.1876704451883425, 0.20958758375450628, 0.16466942871949097, 0.15092608731437207, 0.11815296566589625, 0.11137572118412693, 0.05897522797170257, 0.628357113128526, 0.6070304379192119, 0.6040398685930897, 0.6090666564167261, 0.6482957488745912, 0.6500703372390109, 0.6498167843983313, 0.5788032041062874, 0.5455417117375118, 0.5016652302284009, 0.5102515352258391, 0.44772591507896004, 0.11479720947359656, 0.17454647437001536, 0.3052070371478718, 0.32847351768630423, 0.26587061065282136, 0.3275531837011567, 0.31726758852875003, 0.32108100288812536, 0.3243074833137968, 0.33767047044484955, 0.34568474770619345, 0.358978265865539, 0.19464613462026706, 0.5905070208442013, 0.5575633222460112, 0.5247080738570443, 0.5033516624821474, 0.5462984161266468, 0.5601880381950305, 0.5390893953629237, 0.4753347959867342, 0.45992487285912376, 0.42282149329484736, 0.4198606941691185, 0.4081767272731733, 0.18785164057803871, 0.30318865194202077, 0.42203274750281383, 0.4152772524193739, 0.3908282181500921, 0.441898096155264, 0.4220769783648584, 0.44065637498419036, 0.44220520243875666, 0.43704402835703204, 0.45233351214819073, 0.44268809610986687, 0.23040505363438077, 0.531777140017128, 0.5114199378801201, 0.45325321237932437, 0.40315191302659104, 0.407177557747382, 0.4363308784859366, 0.43197426156214236, 0.3832442666778272, 0.3941619349727207, 0.36899999811502676, 0.3751238651861252, 0.3633331498127276, 0.26783154720242963, 0.39700549075258396, 0.5009817093302312, 0.47877809732735793, 0.4758574878399424, 0.5027652740428173, 0.474587863457316, 0.4696097852448852, 0.4687880966974147, 0.46287635860762244, 0.48541776083022364, 0.4630310593946168, 0.32741234722284546, 0.5433886328207236, 0.5286760344259847, 0.45132989082257824, 0.38093467553948235, 0.35712545504141857, 0.29962845401683613, 0.27785224129422553, 0.24207796329370943, 0.22239649598576275, 0.2036712610960299, 0.1843796091472486, 0.17023262007405504, 0.37635388295810407, 0.45299541543463534, 0.5172858882846885, 0.5078587065159149, 0.5014137906013736, 0.5155818383733244, 0.5083075601157394, 0.5218953006772556, 0.5166672648451704, 0.5073012883466572, 0.4769042782385257, 0.3776256285665791, 0.5121305339810699]

    # p5
    #global best_initial_params = [0.42226178768614825, 0.42320730695870623, 0.5421118799320462, 0.4369389116494993, 0.47712126249926445, 0.490566272478103, 0.5112782186269662, 0.5724533363216685, 0.5662244185883658, 0.5434057035346012, 0.7135492671248532, 0.7606480635595902, 0.13152060810482225, 0.15996554260857515, 0.3954904249064539, -0.21220941070173116, -0.0785021453864585, -0.16124778177335647, 0.26072650165805156, 0.3437414886086789, 0.25106941882672806, 0.33322628968059914, 0.1886763442892698, 0.27279332865537903, 0.09581609090084185, 0.4081125547723198, 0.426213704570675, 0.5870361216431021, 0.4458194618814186, 0.45665141601568815, 0.4979024786565022, 0.534633597033053, 0.6122730523367546, 0.5927657501986715, 0.5909691705997526, 0.7147430600419376, 0.7002079373285076, 0.15389618142786443, 0.12428771392334352, 0.27172708180583943, -0.1362145018348197, -0.012573551111635748, -0.12320996286455105, 0.1753999438325539, 0.18598904788751885, 0.1083163956071557, 0.16667159638972467, 0.020509521728823046, 0.047463955433977786, 0.009191896239750946, 0.35534322622032216, 0.45080831846463626, 0.5908113649701248, 0.4303972878066145, 0.5327806772075874, 0.5949029892288902, 0.6210007625571837, 0.482450107667802, 0.5011112067236226, 0.5842310125819323, 0.4757735273683681, 0.36191041325461787, 0.21976712864268794, 0.11787527364688322, 0.17940906731334277, 0.011267758471049865, 0.1303573817375701, 0.021245986628902692, 0.14823965834464295, 0.13553717400934157, 0.09512804645282605, 0.10824934875445283, 0.11112328938163908, 0.14381550601724766, 0.19632361381004548, 0.3852790165143004, 0.40324140197266795, 0.47097596386898, 0.3973076147472847, 0.5114703604496265, 0.5580007369873997, 0.637540608051382, 0.279930663124353, 0.30372215696311294, 0.5141381209005513, 0.37037703197688787, 0.29159208982590656, 0.29853296396328405, 0.18939783380610128, 0.21757979777736192, 0.1226889680583153, 0.29053334979542794, 0.19290214185637763, 0.20238813115621762, 0.24713833102046387, 0.24618889485898982, 0.19498072956229354, 0.2192606564774138, 0.28575074395823213, 0.1995421910124153, 0.6206271003963608, 0.4705839840940301, 0.3387802144805875, 0.3351958081638342, 0.41353672881957987, 0.4682408927211718, 0.46389772527285683, 0.1897936194103747, 0.18910633394976903, 0.24643126742914245, 0.16913400694198685, 0.13600405942805635, 0.3403888367734686, 0.2974348589412288, 0.29857256587786324, 0.23036538651045194, 0.3564259254967939, 0.2981957839494846, 0.26344794354258094, 0.3278389381893074, 0.33492071892494635, 0.28392099302679386, 0.27162239911358366, 0.29860184636260484, 0.38016214638922485]

    # p15 adjusted params
    global best_initial_params = [0.3886365150952101, 0.3623825230976414, 0.3602795596357849, 0.35910235771401305, 0.3715381685557579, 0.3853994418649158, 0.3983821463883341, 0.41604798270364457, 0.41592987096210543, 0.4421525111903316, 0.4903861223271832, 0.5275547236351212, 0.21102556157211946, 0.2430817372537673, 0.27045368414256893, 0.25784844656761163, 0.2661551175417913, 0.2870599815680628, 0.2908184259713231, 0.3107436569735921, 0.29068402274668814, 0.321967727244109, 0.3185711908425937, 0.30308767160583483, 0.20206903150025976, 0.4155884528764367, 0.38166254543182293, 0.3732357674322047, 0.37312734243762846, 0.39538748364701093, 0.40893703799723885, 0.42490628387287865, 0.44408413249665685, 0.4511254808507516, 0.490128881657831, 0.5218975542602545, 0.5420768182570557, 0.14200097216568913, 0.2040083557182202, 0.2442661467579937, 0.23446483780402994, 0.2266977686339703, 0.2381469865562999, 0.23742974462153613, 0.23875545852557947, 0.21394021126599624, 0.22393681191376338, 0.1905718539957706, 0.15331713447518042, -0.0387164605972808, 0.41193425415699353, 0.38982939784422127, 0.38489071986399687, 0.3747004951332487, 0.4062207487502064, 0.41198899066199846, 0.4261049116377582, 0.43766493916223254, 0.4486375482478037, 0.47249150699403913, 0.4627189539831076, 0.4794400291117987, 0.11158079862286245, 0.1835736579834534, 0.23235034629784498, 0.22221522428586998, 0.20277903900964492, 0.21350624722837513, 0.2103007793142256, 0.20634745961187595, 0.1772364465508014, 0.17701551642710506, 0.1735032878135951, 0.15587595021847087, 0.11465795231304853, 0.4085307644822854, 0.3985773704405539, 0.395437065831527, 0.37017628518951284, 0.4058222068956898, 0.41122150519614414, 0.411915691389975, 0.40914585465605385, 0.417416659744999, 0.4163244532900843, 0.4062993126190983, 0.3961260266173507, 0.12069837645505968, 0.18295731351225863, 0.2372520528483208, 0.22613569451905452, 0.20195210191396562, 0.2214597262132304, 0.2197137098576134, 0.2191285508112583, 0.19276593800674102, 0.1967295240832837, 0.20940641356966969, 0.18659543422497218, 0.23110757355820358, 0.4089318518419342, 0.39560039563743665, 0.39072660720626007, 0.3588018061887577, 0.3877314555323046, 0.39643665202080536, 0.3874087321091262, 0.36642898313528327, 0.37564425995769646, 0.3573196068960177, 0.3504447286240363, 0.32664007585899507, 0.1479749570934789, 0.19475832528532788, 0.2540939538880682, 0.24449324042590598, 0.22273787042162307, 0.24788219227454936, 0.24869305254757657, 0.2562958530421796, 0.23801442907641832, 0.24317926843256896, 0.24878371872356764, 0.25063719346902363, 0.2252055510212999, 0.41144619492348766, 0.3855439077365705, 0.3741445694257067, 0.3404346078360422, 0.35767009443714737, 0.37125425035755905, 0.3544946692052875, 0.3258078104498261, 0.3374127758322269, 0.3151891934230193, 0.30605264314251185, 0.2930063634118548, 0.1762952588223104, 0.2109073155334743, 0.2756762590997539, 0.2707714421298481, 0.2562246318700016, 0.2793963518071052, 0.2804431067378397, 0.2945212787212309, 0.28106317901904204, 0.2843602791990656, 0.2903779490070653, 0.30041071708657807, 0.2420781712125382, 0.41534560589221575, 0.37676426644452854, 0.3542204462207003, 0.3199597637283342, 0.3272305044110648, 0.3441996467364729, 0.323750387232895, 0.30564440740067744, 0.3109963284054044, 0.2909209399683215, 0.2874318049307455, 0.27561347962202565, 0.19715864935327074, 0.2273417037375988, 0.2969541635311385, 0.2983238244433769, 0.29168273430051, 0.306149899721887, 0.30600532048495493, 0.3200399947393721, 0.30901003531899107, 0.31005202114433017, 0.3193995196833549, 0.3256087067538575, 0.26105744381916246, 0.41366331362235714, 0.36989315555873953, 0.33554231810433705, 0.30244193285039406, 0.30205486541451415, 0.31985899687292535, 0.30014112761557343, 0.2973326537785886, 0.29682519981808786, 0.27777431017569915, 0.28123211404657, 0.26949441525986545, 0.208934999676443, 0.24184549511588396, 0.3150696761012129, 0.3225663266226602, 0.32177115437995674, 0.32577080560091415, 0.3234058696075345, 0.33396216716773475, 0.3230872614737221, 0.3240052413258777, 0.33354555803361535, 0.3398285002132426, 0.2656750898572462, 0.4006010731734941, 0.3625681662964631, 0.31928864220063136, 0.289240829850155, 0.2816278628339321, 0.29880842233900656, 0.2835030390745266, 0.2879258431241521, 0.28787673335348074, 0.27195332571740194, 0.27991607366928195, 0.27351338875288184, 0.21516768606515793, 0.25390082190133184, 0.32868860897657387, 0.34083557988481217, 0.34382742826827395, 0.33901386509041104, 0.3353199632376406, 0.34334888117584556, 0.32994100527808284, 0.3318499481550951, 0.3402459448841551, 0.341239914997191, 0.27534168016027893, 0.3793837330450663, 0.3526815551692647, 0.30471774433547427, 0.27636079607843217, 0.26253702235385196, 0.2807884631631896, 0.27338582415727875, 0.2756662808417902, 0.2799150473561267, 0.26908164747067065, 0.28225993770449903, 0.27899909991181565, 0.22076696494511439, 0.2646660311162464, 0.3380945875284565, 0.3521738873488768, 0.35863071678785047, 0.3486878840246127, 0.3445205770789281, 0.35289914712906273, 0.3354678978362617, 0.3368340014666875, 0.3432251584084115, 0.3352921453391302, 0.2929068402023655, 0.35601926064484024, 0.33760500390432296, 0.28924844623661594, 0.2576567825336533, 0.243796404593865, 0.264402259882835, 0.26070991566903423, 0.26650659173810276, 0.2724307435096561, 0.26426649502983, 0.27862201964051503, 0.2768302170999746, 0.23045254667397783, 0.2756366585985766, 0.3447410375171763, 0.3572334986871728, 0.36802466284204527, 0.3567789690437261, 0.3538260226981615, 0.3621964108343592, 0.34264315019072916, 0.34146674410905964, 0.34605847216080576, 0.34059044182444986, 0.3214718260156957, 0.33100258731279003, 0.3169701058373657, 0.2737361843279178, 0.23382829959213847, 0.22668563073558332, 0.245934462829622, 0.24584089595091035, 0.256376559135686, 0.2651999829126259, 0.25576313649967813, 0.26453511910997274, 0.2709657902450849, 0.24615366800739275, 0.2872792714383659, 0.34928254995741814, 0.3575829932095612, 0.37229076138412004, 0.3630966244318527, 0.3631827432041569, 0.37037204288024284, 0.351532004905774, 0.34896552333656616, 0.35410383933541206, 0.3496083448017135, 0.3665391271995125, 0.30440578659492545, 0.2984996688796436, 0.26011808437262623, 0.21297387987891064, 0.2117179928107029, 0.22099518096454301, 0.22291250042105998, 0.2313181457307192, 0.24388274017685738, 0.23807390795030778, 0.24861044874082544, 0.27127611376699984, 0.2657547881304275, 0.2990719920004948, 0.3503976796257038, 0.3537812466585138, 0.36971701989450023, 0.36447602019332015, 0.3689844867861115, 0.3770856797553507, 0.36153892670086135, 0.35841562147368045, 0.3615868726820672, 0.3581416290883402, 0.43452623676901203, 0.2836255411708006, 0.29140072654590404, 0.2556984410322409, 0.20760823999774236, 0.19664099756811904, 0.18560683218402135, 0.18820574280420338, 0.18303606782567422, 0.1839124441644383, 0.18005659335219754, 0.19812088793587138, 0.21610908789445382, 0.28474730554660493, 0.3076206224766538, 0.34529016700556797, 0.344871601323771, 0.3583509115548166, 0.35759248208261696, 0.36738010924787595, 0.3797765053428763, 0.37032490102099014, 0.36743428431197395, 0.36861648426954646, 0.36257065943033795, 0.5813263171239718, 0.32318342107970766, 0.34314050951231406, 0.31392034866852847, 0.27079527608719023, 0.2411372082592116, 0.21869587035966545, 0.22377205606373088, 0.21394365902053472, 0.19537890517976123, 0.1873923129358414, 0.16908503265620856, 0.1639877288153623, 0.2972983366523582, 0.30819843072207853, 0.33006637659391325, 0.3290366440816066, 0.33725536646157656, 0.3397938159303166, 0.35015756200577414, 0.3645660474169785, 0.35947551300600705, 0.3617507875782999, 0.3756600132458551, 0.37714315835911094, 0.7745544376227679]
    
    
    #global learning_rate = 0.0001 #0.00001

    #cost, params, probs = optimize_parameters_mix(MAX_problem, best_initial_params, niter=niter, learning_rate=learning_rate)
    """
    for j in 1:2
        
        cost, params, probs = optimize_parameters_mix(MAX_problem, best_initial_params, niter=niter, learning_rate=learning_rate)
        
        if abs(cost) > abs(best_cost)
            global best_cost = cost
            global best_params = params
            #global best_initial_params = initial_params
            global best_lr = learning_rate
            global best_probs = probs
        else
            break
        end

        global learning_rate += 0.005#0.0001

    end

    for i in 1:2

        cost, params, probs = optimize_parameters_mix(MAX_problem, best_initial_params, niter=niter, learning_rate=learning_rate)
        
        if abs(cost) > abs(best_cost)
            global best_cost = cost
            global best_params = params
            #global best_initial_params = initial_params
            global best_lr = learning_rate
            global best_probs = probs
        else
            break
        end

        global learning_rate += 0.01 #0.01

    end
    """
    # one big increase step for learning rate
    global learning_rate = 0.001
    niter = 0
    
    cost, params, probs = optimize_parameters_mix(MAX_problem, best_initial_params, niter=niter, learning_rate=learning_rate)
        
    if abs(cost) > abs(best_cost)
        global best_cost = cost
        global best_params = params
        #global best_initial_params = initial_params
        global best_lr = learning_rate
        global best_probs = probs
    end
    

    println("Optimal cost: ", best_cost)
    println("Optimal initial parameter: ", best_initial_params[1])
    println("Optimal parameter: ", best_params[1:10])
    println(best_lr)

    
    # save the optimal parameters and cost

    PATH_w = raw"/home/ubuntu/aqc_VQE"

    #folder_name_w = PATH_w * @sprintf("//vqe_MAX2SAT_data//N_%i//p%i//optimized_parameter_data_20//", N, p);
    #folder_name_w = PATH_w * @sprintf("//vqe_MAX2SAT_data//N_%i//p%i//average_parameter_data//", N, p);
    #folder_name_w = PATH_w * @sprintf("//vqe_MAX2SAT_data//N_%i//p%i//final_parameter_data//", N, p);

    #folder_name_w = PATH_w * @sprintf("//vqe_MAX2SAT_data//N_%i//p%i//n12_parameter_test_data//", N, p);

    # test
    #folder_name_w = @sprintf("/home/ubuntu/MAX_vqe_test/")
    folder_name_w = PATH_w * @sprintf("//vqe_MAX2SAT_data_full_fix_time//N_%i//p%i//final_parameter_data//", N, p);


    h5open(folder_name_w * @sprintf("optimized_MAX2SAT_instance_N_%i_idx_%04i.h5", N, idx), "w") do file
        write(file, "ground_state_energy", gs_energy)           
        write(file, "idx", idx)                               # Save seed
        write(file, "cost_value", best_cost)                    # Save cost values
        write(file, "parameter_angles", best_params)            # Save parameters
        write(file, "initial_parameters", best_initial_params)  # Save initial parameters
        write(file, "learning_rate", best_lr)                   # Save learning rate
        write(file, "probabilities", best_probs)                # Save probs
    end
        
end 

println("============================================================ N = ", N, ", ", total_num_inst," instances, done! ============================================================")
